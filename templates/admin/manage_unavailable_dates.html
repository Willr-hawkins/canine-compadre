{% extends "admin/base_site.html" %}

{% block title %}Manage Unavailable Dates{% endblock %}

{% block extrahead %}
<style>
/* Override admin dark theme */
body {
    background: white !important;
    color: #333 !important;
}

#content {
    background: white !important;
}

.calendar-container {
    max-width: 800px;
    margin: 20px auto;
    background: white;
    color: #333;
}

.calendar-container h1, .calendar-container h2, .calendar-container h3, .calendar-container h4, .calendar-container h5, .calendar-container h6 {
    color: #333 !important;
}

.calendar-container p, .calendar-container li, .calendar-container td, .calendar-container th {
    color: #333 !important;
}

.quick-actions {
    text-align: center;
    margin-bottom: 20px;
}

.quick-actions a, .quick-actions button {
    margin: 0 5px;
    padding: 10px 20px;
    border: 1px solid #007bff;
    background: #007bff;
    color: white !important;
    text-decoration: none;
    border-radius: 4px;
    display: inline-block;
    font-weight: bold;
}

.btn-primary { 
    background: #007bff !important; 
    color: white !important; 
    border-color: #007bff !important; 
}

.btn-secondary { 
    background: #6c757d !important; 
    color: white !important; 
    border-color: #6c757d !important; 
}

.btn-success { 
    background: #28a745 !important; 
    color: white !important; 
    border-color: #28a745 !important; 
}

.btn-outline-primary { 
    background: white !important; 
    color: #007bff !important; 
    border: 2px solid #007bff !important;
}

.btn-sm { 
    padding: 6px 12px; 
    font-size: 12px; 
}

.btn-danger {
    background: #dc3545 !important;
    color: white !important;
    border-color: #dc3545 !important;
}

.table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    background: white !important;
}

.table th, .table td {
    padding: 12px;
    border: 2px solid #ddd;
    text-align: left;
    color: #333 !important;
}

.table th {
    background-color: #f8f9fa !important;
    font-weight: bold;
    color: #333 !important;
}

.badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: bold;
}

.badge-danger { 
    background: #dc3545; 
    color: white; 
}

.badge-warning { 
    background: #ffc107; 
    color: #212529; 
}

.instructions {
    background: #e3f2fd !important; 
    padding: 20px; 
    border-radius: 8px; 
    margin-bottom: 20px;
    border: 2px solid #007bff;
}

.instructions h3 {
    color: #007bff !important;
    margin-top: 0;
}

.instructions ol li {
    margin-bottom: 8px;
    color: #333 !important;
}

.instructions p {
    color: #333 !important;
    margin-bottom: 0;
}

.stats {
    margin-top: 30px; 
    display: flex; 
    gap: 20px; 
    justify-content: center;
}

.stat-box {
    text-align: center; 
    padding: 15px; 
    border-radius: 5px;
    min-width: 150px;
}

.stat-blue {
    background: #e3f2fd !important;
    border: 2px solid #1976d2;
}

.stat-blue h4 {
    color: #1976d2 !important;
}

.stat-blue p {
    color: #1976d2 !important;
}

.stat-purple {
    background: #f3e5f5 !important;
    border: 2px solid #7b1fa2;
}

.stat-purple h4 {
    color: #7b1fa2 !important;
}

.stat-purple p {
    color: #7b1fa2 !important;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: #fefefe;
    margin: 10% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 500px;
    border-radius: 5px;
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover {
    color: black;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
}

.form-group input, .form-group textarea, .form-group select {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-sizing: border-box;
}

.form-group textarea {
    height: 80px;
    resize: vertical;
}

.checkbox-group {
    margin: 10px 0;
}

.checkbox-group label {
    display: block;
    margin: 5px 0;
    font-weight: normal;
}

.checkbox-group input {
    width: auto;
    margin-right: 8px;
}

.alert {
    padding: 10px;
    margin: 10px 0;
    border-radius: 4px;
}

.alert-success {
    background-color: #d4edda;
    border-color: #c3e6cb;
    color: #155724;
}

.alert-error {
    background-color: #f8d7da;
    border-color: #f5c6cb;
    color: #721c24;
}
</style>
{% endblock %}

{% block content %}
<div class="calendar-container">
    <h1>Manage Unavailable Dates</h1>
    <p>Use this interface to manage dates when Alex is unavailable. Customers will be automatically notified if their bookings are cancelled.</p>
    
    <div id="alerts"></div>
    
    <!-- Quick Actions -->
    <div class="quick-actions">
        <button onclick="showBulkModal()" class="btn-primary">Mark Date Range Unavailable</button>
        <a href="{% url 'admin:home_groupwalkslotmanager_add' %}" class="btn-secondary">Add Single Date</a>
        <a href="{% url 'admin:home_groupwalkslotmanager_changelist' %}" class="btn-secondary">Manage All Dates</a>
        <button onclick="window.location.reload()" class="btn-secondary">Refresh</button>
    </div>
    
    <!-- Instructions -->
    <div class="instructions">
        <h3>How to Use:</h3>
        <ol>
            <li><strong>Mark Date Range:</strong> Click "Mark Date Range Unavailable" for holidays or longer periods away</li>
            <li><strong>Add Single Date:</strong> Click "Add Single Date" for one-off unavailable dates</li>
            <li><strong>Manage Existing:</strong> Click "Manage All Dates" to view and edit existing unavailable dates</li>
            <li><strong>Automatic Cancellation:</strong> When you mark slots as unavailable, existing bookings will be automatically cancelled</li>
            <li><strong>Customer Notification:</strong> Customers receive professional email notifications about cancellations</li>
        </ol>
        <p><strong>Tip:</strong> Use the "Notes" field to explain why dates are unavailable (holiday, sick day, etc.)</p>
    </div>
    
    <!-- Upcoming Unavailable Dates -->
    {% if upcoming_unavailable %}
    <div>
        <h3>Upcoming Unavailable Dates</h3>
        <table class="table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Status</th>
                    <th>Notes</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for slot_manager in upcoming_unavailable %}
                <tr>
                    <td>{{ slot_manager.date|date:"l, F d, Y" }}</td>
                    <td>
                        {% if not slot_manager.morning_slot_available and not slot_manager.afternoon_slot_available and not slot_manager.evening_slot_available %}
                            <span class="badge badge-danger">All Unavailable</span>
                        {% else %}
                            <span class="badge badge-warning">
                                {% if not slot_manager.morning_slot_available %}Morning {% endif %}
                                {% if not slot_manager.afternoon_slot_available %}Afternoon {% endif %}
                                {% if not slot_manager.evening_slot_available %}Evening {% endif %}
                                Unavailable
                            </span>
                        {% endif %}
                    </td>
                    <td>{{ slot_manager.notes|default:"-" }}</td>
                    <td>
                        <a href="{% url 'admin:home_groupwalkslotmanager_change' slot_manager.pk %}" class="btn-outline-primary btn-sm">Edit</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 5px;">
        <h3>No Upcoming Unavailable Dates</h3>
        <p>All upcoming dates are currently available for booking.</p>
        <button onclick="showBulkModal()" class="btn-primary">Mark Date Range Unavailable</button>
    </div>
    {% endif %}
    
    <!-- Quick Stats -->
    <div class="stats">
        <div class="stat-box stat-blue">
            <h4 style="margin: 0; color: #1976d2;">Total Unavailable</h4>
            <p style="margin: 5px 0 0 0; font-size: 24px; font-weight: bold;">{{ upcoming_unavailable|length }}</p>
        </div>
        <div class="stat-box stat-purple">
            <h4 style="margin: 0; color: #7b1fa2;">Today's Date</h4>
            <p style="margin: 5px 0 0 0; font-size: 18px;">{{ today|date:"M d, Y" }}</p>
        </div>
    </div>
</div>

<!-- Bulk Date Range Modal -->
<div id="bulkModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeBulkModal()">&times;</span>
        <h2>Mark Date Range Unavailable</h2>
        <p>Select a range of dates to mark as unavailable (e.g., for holidays, vacation, etc.)</p>
        
        <form id="bulkForm">
            <div class="form-group">
                <label for="startDate">Start Date:</label>
                <input type="date" id="startDate" required>
            </div>
            
            <div class="form-group">
                <label for="endDate">End Date:</label>
                <input type="date" id="endDate" required>
            </div>
            
            <div class="form-group">
                <label>Time Slots to Mark Unavailable:</label>
                <div class="checkbox-group">
                    <label><input type="checkbox" name="slots" value="morning" checked> Morning (10:00 AM - 12:00 PM)</label>
                    <label><input type="checkbox" name="slots" value="afternoon" checked> Afternoon (2:00 PM - 4:00 PM)</label>
                    <label><input type="checkbox" name="slots" value="evening" checked> Evening (6:00 PM - 8:00 PM)</label>
                </div>
            </div>
            
            <div class="form-group">
                <label for="reason">Reason:</label>
                <textarea id="reason" placeholder="e.g., Holiday in Spain, Family emergency, Sick leave, etc." required></textarea>
            </div>
            
            <div id="datePreview" style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin: 10px 0; display: none;">
                <strong>Dates to mark unavailable:</strong>
                <div id="dateList"></div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button type="button" class="btn-danger" onclick="submitBulkUnavailable()">Mark Dates Unavailable</button>
                <button type="button" class="btn-secondary" onclick="closeBulkModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
function showBulkModal() {
    document.getElementById('bulkModal').style.display = 'block';
    var today = new Date().toISOString().split('T')[0];
    document.getElementById('startDate').min = today;
    document.getElementById('endDate').min = today;
    
    // Add event listeners for date preview
    document.getElementById('startDate').addEventListener('change', updateDatePreview);
    document.getElementById('endDate').addEventListener('change', updateDatePreview);
}

function closeBulkModal() {
    document.getElementById('bulkModal').style.display = 'none';
    document.getElementById('datePreview').style.display = 'none';
}

function updateDatePreview() {
    var startDate = document.getElementById('startDate').value;
    var endDate = document.getElementById('endDate').value;
    
    if (startDate && endDate) {
        var start = new Date(startDate);
        var end = new Date(endDate);
        var dates = [];
        
        if (start <= end) {
            for (var d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                dates.push(new Date(d).toLocaleDateString());
            }
            
            document.getElementById('dateList').innerHTML = dates.join(', ');
            document.getElementById('datePreview').style.display = 'block';
        }
    }
}

function submitBulkUnavailable() {
    var startDate = document.getElementById('startDate').value;
    var endDate = document.getElementById('endDate').value;
    var reason = document.getElementById('reason').value;
    var slotsCheckboxes = document.querySelectorAll('input[name="slots"]:checked');
    var slots = [];
    
    for (var i = 0; i < slotsCheckboxes.length; i++) {
        slots.push(slotsCheckboxes[i].value);
    }
    
    if (!startDate || !endDate) {
        alert('Please select both start and end dates');
        return;
    }
    
    if (slots.length === 0) {
        alert('Please select at least one time slot');
        return;
    }
    
    if (!reason.trim()) {
        alert('Please provide a reason for marking dates unavailable');
        return;
    }
    
    var start = new Date(startDate);
    var end = new Date(endDate);
    
    if (start > end) {
        alert('Start date cannot be after end date');
        return;
    }
    
    // Confirm with user
    var dateCount = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
    if (!confirm('Mark ' + dateCount + ' dates as unavailable?\n\nThis will automatically cancel any existing bookings and notify customers by email.')) {
        return;
    }
    
    // Show loading
    var submitBtn = document.querySelector('.btn-danger');
    var originalText = submitBtn.textContent;
    submitBtn.textContent = 'Processing...';
    submitBtn.disabled = true;
    
    // Generate all dates in range
    var dates = [];
    for (var d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
        dates.push(d.toISOString().split('T')[0]);
    }
    
    // Process each date
    var completed = 0;
    var totalCancelled = 0;
    
    dates.forEach(function(date) {
        var data = {
            date: date,
            slots: slots,
            reason: reason
        };
        
        fetch('/management/mark-date-unavailable/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            completed++;
            if (data.success && data.cancelled_count) {
                totalCancelled += data.cancelled_count;
            }
            
            if (completed === dates.length) {
                // All done
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                
                var message = 'Successfully marked ' + dates.length + ' dates unavailable';
                if (totalCancelled > 0) {
                    message += '. ' + totalCancelled + ' existing bookings were cancelled and customers notified.';
                }
                
                showAlert(message, 'success');
                closeBulkModal();
                
                setTimeout(function() {
                    window.location.reload();
                }, 2000);
            }
        })
        .catch(function(error) {
            completed++;
            console.error('Error processing date ' + date + ':', error);
            
            if (completed === dates.length) {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                showAlert('Some dates may not have been processed correctly. Please check and try again.', 'error');
            }
        });
    });
}

function showAlert(message, type) {
    var alerts = document.getElementById('alerts');
    var alert = document.createElement('div');
    alert.className = 'alert alert-' + (type === 'error' ? 'error' : 'success');
    alert.textContent = message;
    alerts.appendChild(alert);
    
    setTimeout(function() {
        if (alert.parentNode) {
            alert.parentNode.removeChild(alert);
        }
    }, 5000);
}

function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}